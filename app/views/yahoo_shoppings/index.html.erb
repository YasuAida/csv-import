<% content_for :head do %> 
  <div class="panel_container">
    <div class="panel panel-default">
    	<div class="panel-heading">
        ヤフーショッピング管理シート
    	</div>
      <div class="panel-body">
        <%= search_form_for(@q, url: yahoo_shoppings_path) do |f| %>   
          <%= f.label :order_id_cont, "注文IDで検索" %>
          <%= f.search_field :order_id_cont, placeholder: "部分一致"%>
          <%= f.submit "検索", class: 'btn btn-default btn-xs' %>
        <% end %>
        <%= search_form_for(@q, url: yahoo_shoppings_path) do |f| %>   
          <%= f.label :sku_eq, "SKUで検索" %>
          <%= f.search_field :sku_eq, placeholder: "完全一致"%>
          <%= f.submit "検索", class: 'btn btn-default btn-xs' %>
        <% end %>
        <%= search_form_for(@q, url: yahoo_shoppings_path) do |f| %>          
          <%= f.label :goods_name_cont, "商品名で検索" %>
          <%= f.search_field :goods_name_cont, placeholder: "部分一致"%>
          <%= f.submit "検索", class: 'btn btn-default btn-xs' %>
        <% end %>
        <%= search_form_for(@q, url: yahoo_shoppings_path, html: {class: 'date_form'}) do |f| %>           
          <%= f.label :date, "日付で検索"%>
          <%= f.date_select :date_gteq, {include_blank: true, use_month_numbers: true, date_separator: ' / '}, class: "form-control pladmin_form" %>〜
          <%= f.date_select :date_lteq, {include_blank: true, use_month_numbers: true, date_separator: ' / '}, class: "form-control pladmin_form" %>
          <%= f.submit "検索", class: 'btn btn-default btn-xs' %>            
        <% end %>
        <div style="display: inline-block">   
          <%= form_tag({action: 'receipt_upload'}, {multipart: true, class: "form_tag"}) do %>
            <label>受取データ取り込み:</label>
            <%= file_field :receipt_upload, :datafile,{multiple: true, class: 'filestyle', "data-buttonText": "ファイル選択", 'data-input': false} %>         
            <%= submit_tag "UPLOAD", class: 'btn btn-default btn-xs' %>  
          <% end %>
        </div>
        <div style="display: inline-block">   
          <%= form_tag({action: 'payment_upload'}, {multipart: true, class: "form_tag"}) do %>
            <label>支払データ取り込み:</label>
            <%= file_field :payment_upload, :datafile, {multiple: true, class: 'filestyle', "data-buttonText": "ファイル選択", 'data-input': false} %>         
            <%= submit_tag "UPLOAD", class: 'btn btn-default btn-xs' %>  
          <% end %>
        </div>         
      </div>
    </div>
  </div>
        
  <div class="table-responsive">  
    <table class="table table-striped table-bordered table-condensed">
      <thead>
        <tr>
          <th class="update"><a href= ./yahoo_shoppings/destroy class="btn btn-default btn-xs">削除</th>       
          <th class="middle">仕入ID</th>            
          <th class="account">日付</th>      
          <th class="order_num">注文ID</th>
          <th class="asin">SKU</th>
          <th class="content">商品名</th>
          <th class="amount">単価</th>          
          <th class="rate">個数</th>            
          <th class="amount">売上高</th>
          <th class="amount">原価</th>        
          <th class="amount">手数料</th>
          <th class="amount">送料</th>    
          <th class="amount">利益</th> 
          <th class="account">入金日</th>
          <th class="account">送料支払日</th>
          <th class="update"></th>          
        </tr>
      </thead>
<% end %>
      <tbody class="expenseledgers">
        <% @yahoo_shoppings.each do |yahoo_shopping|  %>
        <tr>
          <%= form_for(yahoo_shopping, url: yahoo_shopping_path(yahoo_shopping.id), remote: true) do |f| %>
            <td class="update" id="check-<%= yahoo_shopping.id %>"><%= f.check_box :destroy_check, {}, "true", "false" %></td>      
            <td class="middle"></td>
            <td class="account"><%= f.text_field :date, :size => 8 %></td>          
            <td class="order_num"><%= f.text_field :order_id, :size => 18 %></td>
            <td class="asin"><%= f.text_field :sku, :size => 13 %></td>
            <td class="content"><%= f.text_field :goods_name, :size => 42 %></td>
            <td class="amount"><%= f.text_field :unit_price, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>            
            <td class="rate"><%= f.text_field :number, :size => 1, :style=>"text-align:right"%></td>              
            <td class="amount"><%= f.text_field :sales_amount, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>
            <td class="amount"><%= addcomma(yahoo_shopping.cogs_amount.to_i) %></td>
            <td class="amount"><%= f.text_field :commission, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>            
            <td class="amount"><%= f.text_field :shipping_cost, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>
            <% profit = yahoo_shopping.sales_amount.to_i - yahoo_shopping.commission.to_i - yahoo_shopping.cogs_amount.to_i - yahoo_shopping.shipping_cost.to_i %>
            <td class="amount" style="text-align:right"><%= addcomma(profit)%></td>
            <td class="account"><%= f.text_field :money_receipt_date, :size => 8 %></td>
            <td class="account"><%= f.text_field :shipping_pay_date, :size => 8 %></td>         
            <td class="update" id="submit-<%= yahoo_shopping.id %>"><%= f.submit "更新", class: 'btn btn-default btn-xs'%></td>
            
            <!--チェックボックス更新用JQuery-->
            <script>
              $("#check-<%= yahoo_shopping.id %>").change(function(e){
                $('#edit_yahoo_shopping_<%= yahoo_shopping.id %>').submit();
              });
            </script>
          <% end %> 
        </tr>  
        <% end %>
        <tr>
          <td class="update"></td>      
          <td class="middle"></td>          
          <td class="account"></td>
          <td class="order_num"></td>
          <td class="asin"></td>
          <td class="content" style="text-align:right"></td> 
          <td class="amount">合計</td>
            <% total_number = @yahoo_shoppings.group(:id, :number).sum(:number).values.inject(:+) %> 
          <td class="rate"><%= addcomma(total_number.to_i) %></td>
            <% total_sales_amount = @yahoo_shoppings.group(:id, :sales_amount).sum(:sales_amount).values.inject(:+) %>        
          <td class="amount"><%= addcomma(total_sales_amount.to_i) %></td>
            <% total_cgs_amount = @yahoo_shoppings.group(:id, :cogs_amount).sum(:cogs_amount).values.inject(:+) %>            
          <td class="amount"><%= addcomma(total_cgs_amount.to_i) %></td>
            <% total_commission = @yahoo_shoppings.group(:id, :commission).sum(:commission).values.inject(:+) %>            
          <td class="amount"><%= addcomma(total_commission.to_i) %></td>
            <% total_shipping_cost = @yahoo_shoppings.group(:id, :shipping_cost).sum(:shipping_cost).values.inject(:+) %>            
          <td class="amount"><%= addcomma(total_shipping_cost.to_i) %></td>
            <% total_profit = total_sales_amount.to_i - total_cgs_amount.to_i -  total_commission.to_i - total_shipping_cost.to_i %>
          <td class="amount"><%= addcomma(total_profit.to_i) %></td>   
          <td class="account"></td>
          <td class="account"></td>
          <td class="update"></td>
        </tr>
      </tbody>
<% content_for :foot do %> 
        <%= form_for(@yahoo_shopping) do |f|  %>
      <tbody class="footer">
        <tr>
          <td class="update"></td>
          <td class="middle"></td>
          <td class="account"><%= f.text_field :date, :size => 8 %></td>
          <td class="order_num"><%= f.text_field :order_id, :size => 18 %></td>
          <td class="asin"><%= f.text_field :sku, :size => 13 %></td>
          <td class="content"><%= f.text_field :goods_name, :size => 42 %></td>
          <td class="amount"><%= f.text_field :unit_price, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>           
          <td class="rate"><%= f.text_field :number, :size => 1, :style=>"text-align:right"%></td>               
          <td class="amount"><%= f.text_field :sales_amount, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>
          <td class="amount"></td>
          <td class="amount"><%= f.text_field :commission, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td> 
          <td class="amount"><%= f.text_field :shipping_cost, :size => 6, :style=>"text-align:right", data: { autonumeric: {mDec: 0} } %></td>
          <td class="amount"></td>      
          <td class="account"><%= f.text_field :money_receipt_date, :size => 8 %></td>
          <td class="account"><%= f.text_field :shipping_pay_date, :size => 8 %></td>
          <td class="update"><%= f.submit "登録", class: 'btn btn-default btn-xs'%></td>
        </tr> 
        <% end %>  
      </tbody>
    </table>
  <%= paginate @yahoo_shoppings %>
  </div>
<% end %>  