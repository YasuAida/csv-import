<h1>在庫台帳</h1>

<%= search_form_for(@q, url: stock_list_stockledgers_path) do |f| %>
  <%= f.label :sku_cont, "SKUで検索" %>
  <%= f.search_field :sku_cont %>
  <%= f.submit "検索" %>
  <%= f.label :asin_cont, "ASINで検索" %>
  <%= f.search_field :asin_cont %>
  <%= f.submit "検索" %>
<% end %>

<div class="container-fluid">
  <div class="row">
    <table class="table table-striped">
      <thead>
        <tr>
          <th class="col-sm-1">日付</th>
          <th class="col-sm-1">SKU</th>
          <th class="col-sm-1">ASIN</th>
          <th class="col-sm-1">商品名</th>
          <th class="col-sm-1">数量</th>
          <th class="col-sm-1">単価</th>          
          <th class="col-sm-1">金額</th>
        </tr>
      </thead>
      <tbody>
        <% @stocks.each do |stock| %>
          <tr>
          <% if stock.stockledgers.sum(:grandtotal) != 0 %>          
            <td><%= stock.date %></td>
            <td><%= stock.sku %></td>
            <td><%= stock.asin %></td>
            <td><%= stock.goods_name %></td>
                <% count = stock.stockledgers.sum(:number) %>
            <td><%= sprintf("%.0f",count) %></td>
                <% unit_value = stock.unit_price * stock.rate %>
            <td><%= sprintf("%.0f",unit_value) %></td>            
                <% total_value = stock.stockledgers.sum(:grandtotal) %>
            <td><%= sprintf("%.0f",total_value) %></td>
          <% end %> 
          </tr>
        <% end %>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>個数</td>
            <td><%= @stocks.group(:id, :number).sum(:number).values.inject(:+) %></td>
            <td>合計額</td>            
            <td><%= @stocks.group(:id, :grandtotal).sum(:grandtotal).values.inject(:+) %></td>
          </tr>  
      </tbody>
    </table>
  </div>
</div>