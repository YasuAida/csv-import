<h1>付随費用</h1>

<div class="container-fluid">
  <div class="row">
    <div class="table-responsive">
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th class="small">削除</th>
            <th class="small">ID</th>
            <th class="subexpense">諸掛項目</th>
            <th class="subexpense">按分方法</th>
            <th class="alloc_stock">按分先在庫</th>
            <th class="account">日付</th>
            <th class="account">通貨名</th>      
            <th class="amount">外貨建金額</th>
            <th class="rate">レート</th>
            <th class="amount">円金額</th>
            <th class="account">支払先</th>
            <th class="account">支払日</th>            
          </tr>
        </thead>
        <tbody>
          <% Subexpense.includes(:expense_relation_stocks).all.each do |subexpense| %>
            <tr>
              <%= form_for(subexpense, url: subexpense_path(subexpense)) do |f| %>
              <td class="btn btn-default navbar-btn small"><%= link_to "削除" , subexpense , method: :delete, data: { confirm: '削除してもよろしいですか？' } %></td>
              <th class="small"><%= subexpense.id %></th>
              <td style="white-space:nowrap;"><%= f.collection_select(:item, ExpenseTitle.all, :item, :item, :size=> "20", include_blank: subexpense.item, include_hidden: true) %></td>
              <td style="white-space:nowrap;"><%= f.collection_select(:method, ExpenseMethod.all, :method, :method, :size=> "20", include_blank: subexpense.method, include_hidden: true ,multiple: true) %></td>

              <td style="display:block; white-space:nowrap; overflow:scroll; height:100px; width:500px;">
                <% subexpense.expense_relation_stocks.each do |stock| %>
                  <%= stock.date %> <%= stock.asin %> <%= stock.goods_name %><br>
                <% end %>
              </td>
              <td class="account"><%= f.text_field :date, :size=> "8"%></td>
              <td class="account"><%= f.text_field :currency, :size=> "8"%></td>
              
            <% ex_currency = Currency.find_by(name: subexpense.currency) %>
            <% if ex_currency.method == "外貨×為替レート" %>              
              <td class="amount"><%= f.text_field :amount, :size=> "8", :style=>"text-align:right", data: { autonumeric: {mDec: 2} }%></td>
            <% else %>
              <td class="amount"><%= f.text_field :amount, :size=> "8", :style=>"text-align:right", data: { autonumeric: {mDec: 0} }%></td>
            <% end %>
            
              <td class="rate"><%= subexpense.rate %></td>
            <% yen_amount = BigDecimal(subexpense.amount.to_s).round(2) * subexpense.rate %>
              <td class="amount"><%= addcomma(yen_amount.to_i) %></td>        
              <td class="account"><%= f.text_field :purchase_from, :size=> "8"%></td>
              <td class="account"><%= f.text_field :money_paid, :size=> "8"%></td>
              <td class="update"><%= f.submit "更新", class: 'btn btn-default'%></td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%= link_to "新規登録画面へ", :action => "index" %>